<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGTR Music Player</title>
    <script src="https://unpkg.com/jsmediatags@3.9.7/dist/jsmediatags.min.js"></script>
    <style>
        :root {
            --bg-color: #121212;
            --text-color: #ffffff;
            --accent-color: #1ed760;
            --card-bg: #181818;
            --error-color: #e74c3c;
            --progress-color: #535353;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Arial', sans-serif;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            padding-bottom: 150px;
        }

        header {
            text-align: center;
            padding: 40px 0;
            border-bottom: 2px solid var(--accent-color);
        }

        .input-section {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
            justify-content: center;
        }

        input[type="text"] {
            flex: 1;
            min-width: 300px;
            padding: 12px;
            border: none;
            border-radius: 25px;
            background: var(--card-bg);
            color: var(--text-color);
        }

        button {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            background: var(--accent-color);
            color: white;
            cursor: pointer;
            transition: transform 0.2s;
        }

        button:hover {
            transform: scale(1.05);
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
        }

        .file-input {
            position: absolute;
            opacity: 0;
            width: 0.1px;
            height: 0.1px;
        }

        .visual-file-input {
            padding: 12px 25px;
            border: 2px dashed var(--accent-color);
            border-radius: 25px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
        }

        .visual-file-input:hover {
            background: rgba(255,255,255,0.05);
        }

        .drop-zone {
            border: 2px dashed var(--accent-color);
            padding: 20px;
            text-align: center;
            margin: 20px 0;
            border-radius: 15px;
            transition: all 0.3s;
        }

        .drop-zone.dragover {
            background: rgba(30, 215, 96, 0.1);
            transform: scale(1.02);
        }

        .music-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            padding: 30px 0;
        }

        .music-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 15px;
            transition: transform 0.3s;
            cursor: pointer;
            position: relative;
        }

        .music-card:hover {
            transform: translateY(-5px);
        }

        .delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--error-color);
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1;
        }

        .music-cover {
            width: 100%;
            height: 200px;
            border-radius: 8px;
            object-fit: cover;
            margin-bottom: 15px;
        }

        .player {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            padding: 20px;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .audio-container {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .player-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            justify-content: center;
        }

        .progress-container {
            width: 100%;
            height: 4px;
            background: var(--progress-color);
            border-radius: 2px;
            cursor: pointer;
        }

        .progress {
            height: 100%;
            background: var(--accent-color);
            width: 0;
            border-radius: 2px;
            transition: width 0.1s linear;
        }

        .time-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            color: #b3b3b3;
        }

        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--accent-color);
            color: white;
            padding: 12px 25px;
            border-radius: 25px;
            display: none;
            z-index: 1001;
        }

        .error {
            background: var(--error-color);
        }

        @media (max-width: 768px) {
            .input-section {
                flex-direction: column;
            }
            
            .player-controls button {
                padding: 10px;
                font-size: 1.2em;
            }
            
            .music-card {
                margin: 10px 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>SGTR Music Player</h1>
            <div class="drop-zone" id="dropZone">
                –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∞—É–¥–∏–æ—Ñ–∞–π–ª—ã —Å—é–¥–∞
            </div>
            <div class="input-section">
                <input type="text" id="musicUrl" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª">
                <button onclick="addFromUrl()">–î–æ–±–∞–≤–∏—Ç—å</button>
                <label class="visual-file-input">
                    üìÅ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
                    <input type="file" 
                           class="file-input" 
                           accept="audio/*" 
                           multiple
                           onchange="handleFileSelect(event)">
                </label>
            </div>
        </header>

        <div class="music-list" id="musicList"></div>
    </div>

    <div class="player">
        <div class="audio-container">
            <audio id="audioPlayer"></audio>
            <div class="progress-container" id="progressContainer">
                <div class="progress" id="progress"></div>
            </div>
            <div class="time-info">
                <span id="currentTime">0:00</span>
                <span id="duration">0:00</span>
            </div>
            <div class="player-controls">
                <button onclick="skipBackward()">‚èÆ</button>
                <button onclick="togglePlay()" id="playButton">‚ñ∂</button>
                <button onclick="skipForward()">‚è≠</button>
                <input type="range" 
                       id="volume" 
                       min="0" 
                       max="1" 
                       step="0.1" 
                       value="1"
                       oninput="setVolume(this.value)">
                <button onclick="toggleLoop()" id="loopButton">üîÅ</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        const dbName = 'musicPlayerDB';
        let db;
        let musicList = [];
        let currentTrackIndex = -1;
        let loop = false;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è IndexedDB
        const initDB = () => {
            const request = indexedDB.open(dbName, 1);

            request.onupgradeneeded = (event) => {
                db = event.target.result;
                if (!db.objectStoreNames.contains('tracks')) {
                    const store = db.createObjectStore('tracks', { keyPath: 'id' });
                    store.createIndex('title', 'title', { unique: false });
                }
            };

            request.onsuccess = (event) => {
                db = event.target.result;
                loadTracksFromDB();
            };
        };

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–µ–∫–æ–≤ –∏–∑ –ë–î
        const loadTracksFromDB = () => {
            const transaction = db.transaction(['tracks'], 'readonly');
            const store = transaction.objectStore('tracks');
            const request = store.getAll();

            request.onsuccess = (event) => {
                musicList = event.target.result.map(track => ({
                    ...track,
                    url: URL.createObjectURL(new Blob([track.file], { type: track.mimeType }))
                }));
                renderMusicList();
            };
        };

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç—Ä–µ–∫–∞
        const saveTrackToDB = async (track) => {
            const transaction = db.transaction(['tracks'], 'readwrite');
            const store = transaction.objectStore('tracks');
            store.put(track);
        };

        // –£–¥–∞–ª–µ–Ω–∏–µ —Ç—Ä–µ–∫–∞
        const deleteTrackFromDB = (id) => {
            const transaction = db.transaction(['tracks'], 'readwrite');
            const store = transaction.objectStore('tracks');
            store.delete(id);
        };

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤
        const handleFileSelect = async (event) => {
            const files = event.target.files;
            if (!files.length) return;

            for (const file of files) {
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const metadata = await getAudioMetadata(file);
                    const pictureUrl = metadata.picture ? 
                        URL.createObjectURL(new Blob([metadata.picture.data], {type: metadata.picture.format})) : 
                        '';

                    const track = {
                        id: Date.now() + Math.random(),
                        title: metadata.title || file.name.replace(/\.[^/.]+$/, ""),
                        artist: metadata.artist || 'Unknown Artist',
                        album: metadata.album || '',
                        year: metadata.year || '',
                        url: URL.createObjectURL(file),
                        cover: pictureUrl,
                        isLocal: true,
                        file: arrayBuffer,
                        mimeType: file.type
                    };

                    musicList.push(track);
                    await saveTrackToDB(track);
                    renderMusicList();
                    showToast('–§–∞–π–ª –¥–æ–±–∞–≤–ª–µ–Ω!');
                } catch (error) {
                    showToast('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–∞', true);
                }
            }
        };

        // –ß—Ç–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
        const getAudioMetadata = (file) => {
            return new Promise((resolve, reject) => {
                jsmediatags.read(file, {
                    onSuccess: (tag) => resolve({
                        title: tag.tags.title,
                        artist: tag.tags.artist,
                        album: tag.tags.album,
                        year: tag.tags.year,
                        picture: tag.tags.picture
                    }),
                    onError: () => resolve({})
                });
            });
        };

        // Drag and drop –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        const dropZone = document.getElementById('dropZone');
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            handleFileSelect({ target: { files } });
        });

        // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
        const audioPlayer = document.getElementById('audioPlayer');

        audioPlayer.addEventListener('timeupdate', updateProgress);
        audioPlayer.addEventListener('loadedmetadata', () => {
            document.getElementById('duration').textContent = formatTime(audioPlayer.duration);
        });

        audioPlayer.addEventListener('ended', () => {
            if (loop) {
                audioPlayer.currentTime = 0;
                audioPlayer.play();
            } else {
                skipForward();
            }
        });

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º
        document.getElementById('progressContainer').addEventListener('click', (e) => {
            const rect = e.target.getBoundingClientRect();
            const percent = (e.clientX - rect.left) / rect.width;
            audioPlayer.currentTime = percent * audioPlayer.duration;
        });

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
        const formatTime = (seconds) => {
            const minutes = Math.floor(seconds / 60);
            seconds = Math.floor(seconds % 60);
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        };

        const updateProgress = () => {
            const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
            document.getElementById('progress').style.width = `${progress}%`;
            document.getElementById('currentTime').textContent = formatTime(audioPlayer.currentTime);
        };

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ–º
        const togglePlay = () => {
            if (audioPlayer.paused) {
                audioPlayer.play();
                document.getElementById('playButton').textContent = '‚è∏';
            } else {
                audioPlayer.pause();
                document.getElementById('playButton').textContent = '‚ñ∂';
            }
        };

        const skipForward = () => {
            currentTrackIndex = (currentTrackIndex + 1) % musicList.length;
            playTrack(currentTrackIndex);
        };

        const skipBackward = () => {
            currentTrackIndex = (currentTrackIndex - 1 + musicList.length) % musicList.length;
            playTrack(currentTrackIndex);
        };

        const setVolume = (value) => {
            audioPlayer.volume = value;
        };

        const toggleLoop = () => {
            loop = !loop;
            document.getElementById('loopButton').style.color = loop ? var(--accent-color) : 'white';
        };

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–ø–∏—Å–∫–∞ —Ç—Ä–µ–∫–æ–≤
        const renderMusicList = () => {
            const musicListElement = document.getElementById('musicList');
            musicListElement.innerHTML = '';
            musicList.forEach((track, index) => {
                const card = document.createElement('div');
                card.className = 'music-card';
                card.innerHTML = `
                    ${track.embed ? track.embed : `
                        <img src="${track.cover}" class="music-cover" alt="${track.title}">
                        <h3>${track.title}</h3>
                        <p>${track.artist}</p>
                    `}
                    <div class="delete-btn" onclick="deleteTrack(${index})">√ó</div>
                `;
                if (!track.embed) card.addEventListener('click', () => playTrack(index));
                musicListElement.appendChild(card);
            });
        };

        // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ —Ç—Ä–µ–∫–∞
        const playTrack = (index) => {
            currentTrackIndex = index;
            const track = musicList[index];
            audioPlayer.src = track.url;
            audioPlayer.play();
            document.getElementById('playButton').textContent = '‚è∏';
        };

        // –£–¥–∞–ª–µ–Ω–∏–µ —Ç—Ä–µ–∫–∞
        const deleteTrack = (index) => {
            const track = musicList[index];
            if (track.isLocal) {
                URL.revokeObjectURL(track.url);
                deleteTrackFromDB(track.id);
            }
            musicList.splice(index, 1);
            renderMusicList();
        };

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ URL
        const addFromUrl = () => {
            const url = document.getElementById('musicUrl').value.trim();
            if (!url) return showToast('–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É!', true);

            const track = parseMusicUrl(url);
            if (track) {
                musicList.push(track);
                renderMusicList();
                document.getElementById('musicUrl').value = '';
                showToast('–¢—Ä–µ–∫ –¥–æ–±–∞–≤–ª–µ–Ω!');
            } else {
                showToast('–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–∞—è —Å—Å—ã–ª–∫–∞', true);
            }
        };

        // –ü–∞—Ä—Å–∏–Ω–≥ URL
        const parseMusicUrl = (url) => {
            // YouTube
            const youtubeRegex = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const youtubeMatch = url.match(youtubeRegex);
            if (youtubeMatch && youtubeMatch[2].length === 11) {
                return {
                    embed: `<iframe width="100%" height="200" 
                            src="https://www.youtube.com/embed/${youtubeMatch[2]}?enablejsapi=1" 
                            frameborder="0" 
                            allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" 
                            allowfullscreen></iframe>`,
                    type: 'youtube'
                };
            }

            // Spotify
            const spotifyRegex = /https?:\/\/open.spotify.com\/(track|album|playlist)\/([a-zA-Z0-9]+)/;
            const spotifyMatch = url.match(spotifyRegex);
            if (spotifyMatch) {
                return {
                    embed: `<iframe src="https://open.spotify.com/embed/${spotifyMatch[1]}/${spotifyMatch[2]}" 
                            width="100%" 
                            height="${spotifyMatch[1] === 'track' ? '80' : '380'}" 
                            frameborder="0" 
                            allowtransparency="true" 
                            allow="encrypted-media"></iframe>`,
                    type: 'spotify'
                };
            }

            // –ü—Ä—è–º—ã–µ –∞—É–¥–∏–æ —Å—Å—ã–ª–∫–∏
            if (url.match(/\.(mp3|wav|ogg|m4a|aac|flac)(\?.*)?$/i)) {
                return {
                    url: url,
                    type: 'direct',
                    title: url.split('/').pop().replace(/\.[^/.]+$/, ""),
                    cover: 'https://via.placeholder.com/200'
                };
            }

            return null;
        };

        // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        const showToast = (message, isError = false) => {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${isError ? 'error' : ''}`;
            toast.style.display = 'block';
            setTimeout(() => toast.style.display = 'none', 3000);
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        initDB();
        window.addEventListener('beforeunload', () => {
            musicList.forEach(track => track.isLocal && URL.revokeObjectURL(track.url));
        });
    </script>
</body>
</html>
